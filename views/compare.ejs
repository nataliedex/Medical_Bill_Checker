<%- include('partials/header') -%>

<div class="container my-4">
  <h2><%= title %></h2>
  <p><%= [...new Set(results.map(item => item.cpt_code))].join(", ") %></p>
  

<!-- medicare toggle -->
<div class="card mb-4 shadow-sm">
<div class="card-body">
    <div class="mb-3">
    <div class="form-check form-switch mb-3"> 
        <input class="form-check-input" type="checkbox" id="nonMedicareToggle">
        <label class="form-check-label" for="nonMedicareToggle">Show Non-Medicare Only</label>
    </div>
    </div>
</div>
</div>

  <!-- Pivot Table Card -->
  <% if (pivotResults && pivotResults.length > 0) { %>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="mb-3">
            <label for="setting" class="form-label">Filter by Setting:</label>
            <select class="form-select" id="setting-filter">
              <option value="">All Settings</option>
              <% const uniqueSettings = [...new Set(results.map(r => r.setting || "unknown"))]; %>
              <% uniqueSettings.forEach(s => { %>
                <option value="<%= s %>"><%= s %></option>
              <% }) %>
            </select>
          </div>
          <div class="table-responsive mt-3">
            <table id="pivot-table" class="table table-bordered table-striped table-hover">
              <thead class="table-light">
                <tr>
                  <th>CPT Code</th>
                  <th>Description *AI generated</th>
                  <th>Setting</th>
                  <th>Median Standard Charge</th>
                  <th>Median Negotiated Charge</th>
                  <th>Billed Charges</th>
                </tr>
              </thead>
              <tbody>
                <% pivotResults.forEach(item => { %>
                  <tr>
                    <td><%= item.cpt_code %></td>
                    <td><%= item.description || 'N/A' %></td>
                    <td><%= item.setting %></td>
                    <td>
                      $<%= item.medianStandard ? item.medianStandard.toFixed(0) : '0' %>
                    </td>
                    <td>
                      $<%= item.medianNegotiated ? item.medianNegotiated.toFixed(0) : '0' %>
                    </td>
                    <td>
                        <% if(item.billedCharges != null && item.billedCharges > 0) { %>
                            $<%= item.billedCharges ? item.billedCharges.toFixed(0) : '0' %>
                          <% } else { %>
                            <span class="text-muted">N/A</span>
                          <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
      </div>
    </div>
  <% } %>

  <!-- Raw Data Table Card -->
  <% if (results && results.length > 0) { %>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div>
          <h4>Raw Data for Uploaded CPT Codes:</h4>
          <p><%= [...new Set(results.map(item => item.cpt_code))].join(", ") %></p>
        </div>
        <div class="table-responsive mt-3" style="max-height: 600px; overflow-y:auto;">
          <table id="resultsTable" class="table table-striped table-hover align-middle">
            <thead class="table-dark sticky-top">
              <tr>
                <th>Code</th>
                <th>Description</th>
                <th>Setting</th>
                <th>Standard Charge</th>
                <th>Negotiated Charge</th>
                <th>Payer Name</th>
                <th>Plan Type</th>
              </tr>
            </thead>
            <tbody>
              <% results.forEach(item => { %>
                <tr>
                  <td><%= item.cpt_code %></td>
                  <td><%= item.description %></td>
                  <td><%= item.setting %></td>
                  <td>$<%= Number(item.standard_charge || 0).toFixed(0) %></td>
                  <td>
                    $<%
                      const negotiated = Number(item.negotiated_charge || 0);
                      const cash = Number(item.standard_cash_charge || 0);
                      const standard = Number(item.standard_charge || 0);
                      let price;
                      if (negotiated > 0) price = negotiated;
                      else if (cash > 0) price = cash;
                      else price = standard * 0.9;
                    %>
                    <%= price.toFixed(0) %>
                  </td>
                  <td><%= item.payer %></td>
                  <td><%= item.plan_name %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% } %>
</div>

<% if (results && results.length > 0) { %>
    <script>
        window.pivotData = <%- JSON.stringify(pivotResults) %>;
        window.showBilledCharges = true;
        window.billedChargesMap = <%- JSON.stringify(pivotResults.reduce((acc, row) => {
          acc[row.cpt_code] = row.billedCharges;
          return acc;
        }, {})) %>;
    </script>
<% } %>

<script type="module" src="/js/main.js"></script>
<%- include('partials/footer') -%>