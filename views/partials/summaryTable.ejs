<% if (data && data.length > 0) { %>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
    
        <!-- Filter -->
        <div class="mb-3">
            <label for="setting" class="form-label">Filter by Setting:</label>
            <select class="form-select" id="setting-filter">
              <option value="">All Settings</option>
              <% const uniqueSettings = [...new Set(results.map(r => r.setting || "unknown"))]; %>
              <% uniqueSettings.forEach(s => { %>
                <option value="<%= s %>"><%= s %></option>
              <% }) %>
            </select>
          </div>
    
        <!-- CPT Title -->
        <div> 
          <h4>Summary Table for:</h4>
          <p><%= [...new Set(data.map(item => item.cpt_code))].join(", ") %></p>
        </div>
    
        <!-- Table -->
        <div class="table-responsive mt-3">
          <table id="pivot-table" class="table table-bordered table-striped table-hover">
            <thead class="table-light sticky-top">
              <tr>
                <% if (showDisputeColumn) { %>
                  <th>Dispute</th>
                <% } %>
                <th>CPT Code</th>
                <th>Description *AI generated response</th>
                <th>Setting</th>
                <th>Median Standard Charge</th>
                <th>Median Negotiated Charge</th>
                <% if (showBilledColumn) { %>
                  <th>Billed Charges</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% data.forEach(item => { %>
                <tr class="pivot-data-row">
                  <% if (showDisputeColumn) { %>
                    <td><input type="checkbox" class="dispute-checkbox"></td>
                  <% } %>
                  <td><%= item.cpt_code %></td>
                  <td><%= item.description || 'N/A' %></td>
                  <td><%= item.setting || 'N/A' %></td>
                  <td>$<%= item.medianStandard ? item.medianStandard.toFixed(0) : '0' %></td>
                  <td>$<%= item.medianNegotiated ? item.medianNegotiated.toFixed(0) : '0' %></td>
                  <% if (showBilledColumn) { %>
                    <td>
                      <% if (item.billedCharges != null && item.billedCharges > 0) { %>
                        $<%= item.billedCharges.toFixed(0) %>
                      <% } else { %>
                        <span class="text-muted">N/A</span>
                      <% } %>
                    </td>
                  <% } %>
                </tr>
    
    
              <% }); %>
            </tbody>
          </table>
        </div>

        <!-- Extra Dispute Info Row -->
        <div id="dispute-extra-info-row" class="row align-items-center mt-4" style="display: none;">
          <div class="col-auto">
            <label for="extraDisputeInfo" class="form-label">Additional Details:</label>
          </div>

          <div class="col">
            <input 
              type="text" 
              id="extraDisputeInfo" 
              class="form-control" 
              placeholder="Add details for the dispute letter"
            >
          </div>
        </div>
    
        <!-- Generate Visit Summary -->
        <button id="generateVisitSummaryBtn" class="btn btn-secondary mt-3">Generate Visit Summary</button>
        <div id="visit-summary-container" class="mt-3 mb-3"></div>

        <% if (showLetterBtn) { %>
          <button id="generateLetterBtn" class="btn btn-primary mt-3">Generate Letter</button>
          <button type="button" class="btn btn-primary mt-3 export-letter-btn" style="display: none;">Export Letter</button>
          <pre id="generated-letter" style="font-family: inherit; white-space: pre-wrap; font-size: 16px; line-height: 1.6;"></pre>
        <% } %>
    
      </div>
    </div>
    <% } %>