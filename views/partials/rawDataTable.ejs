<% if (results && results.length > 0) { %>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h4>Raw Data for Uploaded CPT Codes:</h4>
              <p><%= [...new Set(results.map(item => item.cpt_code))].join(", ") %></p>
            </div>
            <div>
              <button type="button" class="btn btn-success export-btn">Export</button>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check form-switch mb-3"> 
              <input class="form-check-input" type="checkbox" id="nonMedicareToggle">
              <label class="form-check-label" for="nonMedicareToggle">Show Non-Medicare Only</label>
            </div>
          </div>
        </div>
        <div class="table-responsive mt-3" style="max-height: 600px; overflow-y:auto;">
          <table id="resultsTable" class="table table-striped table-hover align-middle">
            <thead class="table-dark sticky-top">
              <tr>
                <th>Code</th>
                <th>Setting</th>
                <th>Standard Charge</th>
                <th>Negotiated Charge</th>
                <th>Payer Name</th>
                <th>Plan Type</th>
              </tr>
            </thead>
            <tbody id="results-table">
              <% results.forEach(item => { %>
                <tr>
                  <td><%= item.cpt_code %></td>
                  <td><%= item.setting %></td>
                  <td>$<%= Number(item.standard_charge || 0).toFixed(0) %></td>
                  <td>$
                    <%
                      const negotiated = Number(item.negotiated_charge || 0);
                      const cash = Number(item.standard_cash_charge || 0);
                      const standard = Number(item.standard_charge || 0);
                      let price;
                      if (negotiated > 0) price = negotiated;
                      else if (cash > 0) price = cash;
                      else price = standard * 0.9;
                    %>
                    <%= price.toFixed(0) %>
                  </td>
                  <td><%= item.payer %></td>
                  <td><%= item.plan_name %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% } %>