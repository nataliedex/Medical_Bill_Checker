<%- include('partials/header') -%>

<div class="container my-4">
  <h2><%= title %></h2>

  <!-- Search Form should always be visible -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form id="input-cpt-code" action="/search" method="get" class="mb-0">
        <div class="mb-3">
          <label for="hospital" class="form-label">Select Hospital:</label>
          <select class="form-select" name="hospital" id="hospital" required>
            <option value=""></option>
            <option value="nch_data" <%= hospital === 'nch_data' ? 'selected' : '' %>>Nationwide Childrenâ€™s Hospital</option>
            <option value="osu_data" <%= hospital === 'osu_data' ? 'selected' : '' %>>OSU Medical Center</option>
            <option value="riversideMethodist_data" <%= hospital === 'riversideMethodist_data' ? 'selected' : '' %>>Riverside Methodist</option>
          </select>
        </div>

        <h3 class="card-title mb-3">Search CPT Codes</h3>
        <div class="mb-3">
          <label for="code" class="form-label">Enter CPT Code(s): </label>
          <input
            type="text"
            class="form-control"
            name="code"
            id="code"
            placeholder="e.g. 99213, 99285, 99281"
            value="<%= codes || '' %>"
          >
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Search</button>
          <% if(results && results.length > 0) { %>
            <button type="button" id="exportBtn" class="btn btn-success">Export</button>
            <a href="/" class="btn btn-secondary">New Search</a>
          <% } %>
        </div>
      </form>
    </div>
  </div>

  <!-- Only show tables/results if data is present -->
  <% if (results && results.length > 0) { %>


    <!-- medicare toggle -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="nonMedicareToggle">
            <label class="form-check-label" for="nonMedicareToggle">Show Non-Medicare Only</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Pivot Table -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <label for="setting" class="form-label">Filter by Setting:</label>
          <select class="form-select" id="setting-filter">
            <option value="">All Settings</option>
            <% const uniqueSettings = [...new Set(results.map(r => r.setting || "unknown"))]; %>
            <% uniqueSettings.forEach(s => { %>
              <option value="<%= s %>"><%= s %></option>
            <% }) %>
          </select>
        </div>
        <div>
          <h4>Summary Table for:</h4>
          <p><%= [...new Set(results.map(item => item.cpt_code))].join(", ") %></p>
        </div>
        <div class="table-responsive mt-3">
          <table id="pivot-table" class="table table-bordered table-striped table-hover">
            <thead class="table-light sticky-top">
              <tr>
                <th>CPT Code</th>
                <th>Setting</th>
                <th>Median Standard Charge</th>
                <th>Median Negotiated Charge</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Raw Data Table -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div>
          <h4>Search Results for:</h4>
          <p><%= [...new Set(results.map(item => item.cpt_code))].join(", ") %></p>
        </div>
        <div class="table-responsive mt-3" style="max-height: 600px; overflow-y:auto;">
          <table id="resultsTable" class="table table-striped table-hover align-middle">
            <thead class="table-dark sticky-top">
              <tr>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(0)">Code <i class="bi bi-arrow-down-up"></i></th>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(1)">Description <i class="bi bi-arrow-down-up"></i></th>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(2)">Setting <i class="bi bi-arrow-down-up"></i></th>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(3)">Standard Charge <i class="bi bi-arrow-down-up"></i></th>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(4)">Negotiated Charge <i class="bi bi-arrow-down-up"></i></th>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(5)">Payer Name <i class="bi bi-arrow-down-up"></i></th>
                <th scope="col" style="cursor:pointer;" onclick="sortTable(6)">Plan Type <i class="bi bi-arrow-down-up"></i></th>
              </tr>
            </thead>
            <tbody id="results-table">
              <% results.forEach(item => { %>
                <tr>
                  <td><%= item.cpt_code %></td>
                  <td><%= item.description %></td>
                  <td><%= item.setting %></td>
                  <td>$<%= Number(item.standard_charge || 0).toFixed(0) %></td>
                  <td>
                    $<%
                      const negotiated = Number(item.negotiated_charge || 0);
                      const cash = Number(item.standard_cash_charge || 0);
                      const standard = Number(item.standard_charge || 0);
                      let price;
                      if (negotiated > 0) price = negotiated;
                      else if (cash > 0) price = cash;
                      else price = standard * 0.9;
                    %>
                    <%= price.toFixed(0) %>
                  </td>
                  <td><%= item.payer %></td>
                  <td><%= item.plan_name %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% } %>
</div>

<% if (results && results.length > 0) { %>
  <script>
    window.pivotData = <%- JSON.stringify(results) %>;
  </script>
<% } %>

<%- include('partials/footer') -%>